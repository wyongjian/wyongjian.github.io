<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Wang Yongjian, email:blog@wangyongjian">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>西门子串口通讯模块CP341装载ModBus从站协议全双工通讯的实现 - Wangongjian's blog</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u897f\u95e8\u5b50\u4e32\u53e3\u901a\u8baf\u6a21\u5757CP341\u88c5\u8f7dModBus\u4ece\u7ad9\u534f\u8bae\u5168\u53cc\u5de5\u901a\u8baf\u7684\u5b9e\u73b0";
    var mkdocs_page_input_path = "INET\\CP341ModBusFull.md";
    var mkdocs_page_url = "/INET/CP341ModBusFull/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?88fa97e58700853ce6c7b9899524e14a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Wangongjian's blog</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">首页</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">工业通讯</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../simpleOPCUA/">OPC UA技术标准简单分析</a>
                </li>
                <li class="">
                    
    <a class="" href="../OPCUAX509/">OPC UA安全认证证书分析</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">西门子串口通讯模块CP341装载ModBus从站协议全双工通讯的实现</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#cp341modbus">西门子串口通讯模块CP341装载ModBus从站协议全双工通讯的实现</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#_1">项目概述</a></li>
        
            <li><a class="toctree-l4" href="#_2">遇到的问题</a></li>
        
            <li><a class="toctree-l4" href="#_3">解决的方法</a></li>
        
            <li><a class="toctree-l4" href="#_4">结论</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">CNC数控系统</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../CNC/VirtualCNCForTest/">虚拟数控机床测试系统的搭建</a>
                </li>
                <li class="">
                    
    <a class="" href="../../CNC/NCFileTransferProtocolZModem/">NC代码传输协议详细解析</a>
                </li>
                <li class="">
                    
    <a class="" href="../../CNC/FanucCNCMonitor/">Fanuc 数控机床联网监控方案分析</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">MES及智能制造</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../MES/thinkofMaterialcode/">对物料编码的理解</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">数据库相关</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../Database/OracleODPForNet/">不安装客户端连接ORACLE数据库</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Database/LabVIEWAndSQLite/">LabVIEW访问SQLite数据库接口研究</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">信息安全</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../IS/X509ForOPCUA/">OPC UA安全认证证书分析</a>
                </li>
                <li class="">
                    
    <a class="" href="../../IS/IndustrialEnterpriseInformationSecurity/">工业企业信息安全分析</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">控制技术</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../Control/ControlForGranulator/">制粒机的无模型自适应控制</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">个人观点</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../PrivateOpinions/StartUseEffevo/">Effevo开发项目管理平台使用总结</a>
                </li>
                <li class="">
                    
    <a class="" href="../../PrivateOpinions/HowToShowPPT/">演讲的艺术</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">所思所想</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../Idear/ProductPackage/">产品包装</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Idear/SwimToUpstream/">拼搏，目标上游</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Idear/TheCultureOfWolf/">狼性文化</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Idear/DisruptiveTheTime/">颠覆的时代</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Wangongjian's blog</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>工业通讯 &raquo;</li>
        
      
    
    <li>西门子串口通讯模块CP341装载ModBus从站协议全双工通讯的实现</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="cp341modbus">西门子串口通讯模块CP341装载ModBus从站协议全双工通讯的实现</h1>
<p>原创作者：王永建(blog@wangyongjian.cn)</p>
<p>原文引用地址：blog.wangyongjian.cn               </p>
<hr />
<p><strong>[摘 要]</strong>
通过试验实现了西门子串口通讯模块CP341装载ModBus从站协议时的全双工通讯
<strong>[关键词]</strong>CP341 Modbus 全双工通讯    </p>
<h2 id="_1"><strong>项目概述</strong></h2>
<p>安钢1#煤气加压站GMC煤气混合控制系统采用西门子公司S7-400H系列过程控制系统及安装有CyboSoft系列控制软件CyboCon的MFA先进控制站构成。如图-1所示
    <img alt="系统结构图" src="../CP341ModBusFull-1.jpg" />
MFA先进控制站通过CP341与S7-400H系统实现数据通讯，采用的是ModBus协议，RTU格式，CP341装载ModBus从站协议，作为从站与MFA先进控制站通讯。在MFA先进控制站侧安装有研华的ADMA4520模块，使其具有RS485和RS422通信接口。</p>
<p>CyboCon是由通控集团博软公司（CyboSoft，General Cybernation Group Inc.）开发并拥有的专利技。基于MFA核心控制技术是世界上首套“即插即用”式单变量和多变量控制软件，可自适应控制简单或复杂的工业过程。它以无模型自适应理论为基础，无需进行控制器设计、没有辨识过程，也不需知道过程的定量知识，就可将控制器投入运行。即使过程的动态特性有很大变化，也不需重新整定控制器参数。</p>
<h2 id="_2"><strong>遇到的问题</strong></h2>
<p>主要问题出现在MFA先进控制站与西门子系统通讯方面。系统最初的设计是MFA先进控制站与CP341之间通过RS485的形式连接。问题就出在此：MFA先进控制站的Modbus驱动是在RS232的接口基础上开发的，通讯方式为全双工。而通过RS485与CP341连接时，只能实现半双工通讯。于是在现场就出现了一些问题：进行小的数据量（寄存器读写总数不超过10个）时，通讯基本上还是正常可以进行的，但是不同程度上会出现数据丢失的现象（图2）。如再增加通讯数据量，数据丢失将更加明显，甚至出现通讯中断。</p>
<p><img alt="丢包现象" src="../CP341ModBusFull-2.jpg" /></p>
<p>从西门子的相关资料上查到的结果是可以通过改用RS422接口来实现全双工通讯。而且在Step7的组态环境中的设计选项也说明了，CP341 是可以工作在全双工模式下的（图3）。
  <img alt="CP341全双工设置" src="../CP341ModBusFull-3.jpg" /></p>
<p>由于 PLC控制器同时还担负着现场三台加压机的运行监视和故障连锁保护，而且已经在运行了。从安全角度考虑，于是先和西门子技术支持确认了一下方案的可实施性，得到的答复却是不行，理由是Modbus协议不支持全双工通讯所以用RS-422来实现全双工通讯是不可行的。这个解释很显然说不过去。这就与西门子提供的资料有矛盾了。</p>
<p>西门子提供的另一种方案就是再额外增加一块CP341模块。一收一发。这个方案理论上确实可以解决问题。这样不但要增加成本，而且CP341国内没有库存，订货周期长达六周以上。此方案只能作为下下策备选。</p>
<h2 id="_3"><strong>解决的方法</strong></h2>
<p>矛盾之下只能实测，最佳方案只能是尝试采用RS422的通讯方式。在做好充分准备后，在软件中将CP341的接口设置为RS422接口方式，编译后下载。将电气连接按图4所示，改为RS422连接方式。然后在MFA工作站用Modscan软件扫描测试，测试显示，得不到测试数据返回值。
   <img alt="CP341接线图" src="../CP341ModBusFull-4.jpg" />
注：图4中的接线图通过实际证明是错误的。正确接线方式详见下面的接线说明。 
在反复进行了接线检查，多次修改配置软件后均无法通讯成功。后通过观察4520的指示灯发现，通过由4520有数据发出，但是CP341没有任何反应。在对软件和硬件连线进行了数次检查后，仍是无法通讯成功后。最后怀疑是还是接线有问题，将ADMA4520与CP341之间的接线进行了试探性顺序调整，在将ADMA4520与CP341直接的接线顺序调整为TX+--TB，TX---TA，RX+ --RB，RX- --RA时，发现4520的红灯开始闪烁，通过测试观察，通讯成功。而且效果很好。如图5：
   <img alt="全双工效果" src="../CP341ModBusFull-5.jpg" />
注：将sine信号送MFA或PID控制器的OTV端，经RS-422通讯送SIEMENS CP341，PLC将接收到的数据送回，连接控制器的PV端。当通讯实时性差的时候CyboCon实时趋势的PV与OP无法重合，滞后于OP值。而利用RS-422全双工通讯则实时性很好。</p>
<h2 id="_4"><strong>结论</strong></h2>
<p>RS-422全双工通讯方式能够满足安钢项目的通讯需要，无需再另行购买SIEMENS CP341产品。</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../CNC/VirtualCNCForTest/" class="btn btn-neutral float-right" title="虚拟数控机床测试系统的搭建">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../OPCUAX509/" class="btn btn-neutral" title="OPC UA安全认证证书分析"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright &copy; 2018 <a href="blog.wangyongjian.cn">Wang Yongjian</a>.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../OPCUAX509/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../CNC/VirtualCNCForTest/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/require.js"></script>
      <script src="../../search/search.js"></script>


<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
</body>
</html>
